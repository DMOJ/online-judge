{% extends "base.html" %}


{% block title %}{{ title }}{% endblock %}

{% block js_media %}
    <script type="text/javascript" src="{{ ACE_URL }}/ace.js"></script>
    {% if REQUIRE_JAX %}
        {% include "mathjax-load.html" %}
    {% endif %}
    <script type="text/javascript">
        $(function() {
            // Initialize ACE editors
            var codeEditor = ace.edit("code-editor");
            codeEditor.setTheme("ace/theme/{{ ace_theme }}");
            codeEditor.getSession().setMode("ace/mode/python");
            codeEditor.setFontSize(14);
            codeEditor.getSession().setUseWrapMode(true);
            codeEditor.setPrintMarginColumn(100);

            var inputEditor = ace.edit("input-editor");
            inputEditor.setTheme("ace/theme/{{ ace_theme }}");
            inputEditor.setFontSize(14);
            inputEditor.getSession().setUseWrapMode(true);

            var outputDisplay = ace.edit("output-display");
            outputDisplay.setTheme("ace/theme/{{ ace_theme }}");
            outputDisplay.setReadOnly(true);
            outputDisplay.setFontSize(14);
            outputDisplay.getSession().setUseWrapMode(true);
            outputDisplay.renderer.setShowGutter(false);

            // Language selection
            $('#language-select').select2({
                theme: '{{ DMOJ_SELECT2_THEME }}'
            });

            // Language change handler
            $('#language-select').change(function() {
                var selectedOption = $(this).find('option:selected');
                var lang = selectedOption.data('ace');
                codeEditor.getSession().setMode("ace/mode/" + lang);

                // Load template from localStorage or AJAX
                var langId = $(this).val();
                var storageKey = 'ide_code:' + langId;
                var cached = localStorage.getItem(storageKey);

                if (cached != null && codeEditor.getValue().trim() === '') {
                    codeEditor.setValue(cached, -1);
                } else if (codeEditor.getValue().trim() === '') {
                    // Load language template via AJAX
                    $.get('{{ url("language_template_ajax") }}', {
                        id: langId,
                        _: Date.now() + Math.random()
                    }, function(template) {
                        if (template && template.trim()) {
                            codeEditor.setValue(template, -1);
                            localStorage.setItem(storageKey, template);
                        }
                    }).fail(function() {
                        console.log('Failed to load language template');
                    });
                }
            });

            // Auto-save code to localStorage
            var saveTimer;
            codeEditor.on('change', function() {
                clearTimeout(saveTimer);
                saveTimer = setTimeout(function() {
                    var langId = $('#language-select').val();
                    if (langId) {
                        localStorage.setItem('ide_code:' + langId, codeEditor.getValue());
                    }
                }, 1000);
            });

            // Auto-save input to localStorage
            var inputSaveTimer;
            inputEditor.on('change', function() {
                clearTimeout(inputSaveTimer);
                inputSaveTimer = setTimeout(function() {
                    localStorage.setItem('ide_input', inputEditor.getValue());
                }, 1000);
            });

            // Load saved input from localStorage
            var savedInput = localStorage.getItem('ide_input');
            if (savedInput) {
                inputEditor.setValue(savedInput, -1);
            }

            // Run button handler
            var currentSubmissionId = null;
            var statusCheckInterval = null;

            $('#run-button').click(function() {
                var button = $(this);
                var sourceCode = codeEditor.getValue();
                var languageId = $('#language-select').val();
                var customInput = inputEditor.getValue();

                if (!sourceCode.trim()) {
                    outputDisplay.setValue('{{ _("Error: Source code cannot be empty") }}', -1);
                    return;
                }

                if (!languageId) {
                    outputDisplay.setValue('{{ _("Error: Please select a language") }}', -1);
                    return;
                }

                button.prop('disabled', true).text('{{ _("Running...") }}');
                outputDisplay.setValue('{{ _("Submitting code to judge...") }}', -1);

                $.ajax({
                    url: '{{ url("ide_submit") }}',
                    method: 'POST',
                    data: {
                        source: sourceCode,
                        language: languageId,
                        input: customInput,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function(response) {
                        currentSubmissionId = response.submission_id;
                        outputDisplay.setValue('{{ _("Submission received. Judging...") }}\n', -1);

                        // Start polling for status
                        statusCheckInterval = setInterval(checkSubmissionStatus, 500);
                    },
                    error: function(xhr) {
                        button.prop('disabled', false).text('{{ _("Run Code") }}');
                        var error = '{{ _("Error:") }} ';
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            error += xhr.responseJSON.error;
                        } else {
                            error += '{{ _("Unknown error occurred") }}';
                        }
                        outputDisplay.setValue(error, -1);
                    }
                });
            });

            function checkSubmissionStatus() {
                if (!currentSubmissionId) {
                    clearInterval(statusCheckInterval);
                    return;
                }

                $.get('{{ url("ide_submission_status", 0) }}'.replace('0', currentSubmissionId))
                    .done(function(data) {
                        // Check if submission is complete
                        if (data.status === 'D' || data.status === 'IE' || data.status === 'CE' || data.status === 'AB') {
                            // Submission complete
                            clearInterval(statusCheckInterval);
                            $('#run-button').prop('disabled', false).text('{{ _("Run Code") }}');

                            var output = '';

                            if (data.status === 'CE') {
                                output = '{{ _("Compilation Error") }}\n\n';
                                output += data.error || '{{ _("(no error message)") }}';
                            } else if (data.status === 'IE') {
                                output = '{{ _("Internal Error") }}\n\n';
                                output += '{{ _("An error occurred on the judge server. Please try again or contact an administrator.") }}';
                            } else if (data.status === 'AB') {
                                output = '{{ _("Aborted") }}\n\n';
                                output += '{{ _("The submission was aborted.") }}';
                            } else {
                                // Normal completion
                                output = '{{ _("Result:") }} ' + (data.result || 'N/A') + '\n';
                                if (data.time !== null && data.time !== undefined) {
                                    output += '{{ _("Time:") }} ' + data.time.toFixed(3) + 's\n';
                                }
                                if (data.memory !== null && data.memory !== undefined) {
                                    output += '{{ _("Memory:") }} ' + data.memory.toFixed(0) + ' KB\n';
                                }
                                output += '\n{{ _("Output:") }}\n';
                                output += data.output || '{{ _("(no output)") }}';
                            }

                            outputDisplay.setValue(output, -1);
                            outputDisplay.gotoLine(1);
                        } else {
                            // Still processing
                            var statusText = '';
                            if (data.status === 'QU') {
                                statusText = '{{ _("Queued...") }}';
                            } else if (data.status === 'P') {
                                statusText = '{{ _("Processing...") }}';
                            } else if (data.status === 'G') {
                                statusText = '{{ _("Grading...") }}';
                            }
                            outputDisplay.setValue(statusText, -1);
                        }
                    })
                    .fail(function(xhr) {
                        clearInterval(statusCheckInterval);
                        $('#run-button').prop('disabled', false).text('{{ _("Run Code") }}');
                        var error = '{{ _("Error checking status:") }} ';
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            error += xhr.responseJSON.error;
                        } else {
                            error += '{{ _("Failed to retrieve submission status") }}';
                        }
                        outputDisplay.setValue(error, -1);
                    });
            }

            // Keyboard shortcuts
            codeEditor.commands.addCommand({
                name: 'runCode',
                bindKey: {win: 'Ctrl-Enter', mac: 'Command-Enter'},
                exec: function(editor) {
                    $('#run-button').click();
                }
            });

            // Responsive sizing
            function resizeEditors() {
                var windowHeight = $(window).height();
                var headerHeight = $('.ide-controls').outerHeight(true) + 100; // controls + header
                var availableHeight = Math.max(windowHeight - headerHeight, 400);

                var codeHeight = Math.floor(availableHeight * 0.9);
                var sideHeight = Math.floor(availableHeight * 0.42);

                $('#code-editor').height(codeHeight);
                $('#input-editor').height(sideHeight);
                $('#output-display').height(sideHeight);

                codeEditor.resize();
                inputEditor.resize();
                outputDisplay.resize();
            }

            $(window).resize(resizeEditors);
            resizeEditors();

            // Initialize with default language
            $('#language-select').val({{ default_lang.id }}).trigger('change');
        });
    </script>
{% endblock %}

{% block media %}
    <style>
        .ide-header {
            padding: 15px 20px;
            background: var(--header-bg, #f8f9fa);
            border-bottom: 1px solid var(--border-color, #dee2e6);
        }

        .ide-header h1 {
            margin: 0 0 10px 0;
            font-size: 1.5rem;
        }

        .ide-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        #language-select {
            min-width: 250px;
        }

        #run-button {
            padding: 8px 24px;
            font-size: 14px;
            font-weight: bold;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        #run-button:hover:not(:disabled) {
            background: #218838;
        }

        #run-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .rate-limit-info {
            font-size: 13px;
            color: #6c757d;
            margin-left: auto;
        }

        .ide-container {
            display: flex;
            gap: 10px;
            padding: 10px;
            height: calc(100vh - 200px);
        }

        .ide-left {
            flex: 1.5;
            display: flex;
            flex-direction: column;
        }

        .ide-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .editor-panel {
            border: 1px solid var(--border-color, #dee2e6);
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .ide-left .editor-panel {
            flex: 1;
        }

        .ide-right .editor-panel {
            flex: 1;
        }

        .editor-header {
            background: var(--header-bg, #f8f9fa);
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color, #dee2e6);
            font-weight: 600;
            font-size: 14px;
        }

        .editor-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #code-editor, #input-editor, #output-display {
            width: 100%;
            height: 100%;
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .ide-header {
                background: #2d3748;
                border-bottom-color: #4a5568;
            }

            .editor-panel {
                background: #1a202c;
                border-color: #4a5568;
            }

            .editor-header {
                background: #2d3748;
                border-bottom-color: #4a5568;
                color: #e2e8f0;
            }

            .rate-limit-info {
                color: #a0aec0;
            }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .ide-container {
                flex-direction: column;
            }

            .ide-left, .ide-right {
                flex: none;
            }

            .ide-controls {
                flex-direction: column;
                align-items: stretch;
            }

            #language-select {
                width: 100%;
            }

            .rate-limit-info {
                margin-left: 0;
            }
        }
    </style>
{% endblock %}

{% block body %}
    <div class="ide-header">
        <h1>{{ _('IDE') }}</h1>
        <div class="ide-controls">
            <select id="language-select">
                {% for lang in languages %}
                    <option value="{{ lang.id }}" data-ace="{{ lang.ace }}"
                            {% if lang.id == default_lang.id %}selected{% endif %}>
                        {{ lang.name }}
                    </option>
                {% endfor %}
            </select>

            <button id="run-button" class="button">{{ _('Run Code') }}</button>

        </div>
    </div>

    <div class="ide-container">
        <div class="ide-left">
            <div class="editor-panel">
                <div class="editor-header">{{ _('Code Editor') }}</div>
                <div class="editor-content">
                    <div id="code-editor"></div>
                </div>
            </div>
        </div>

        <div class="ide-right">
            <div class="editor-panel">
                <div class="editor-header">{{ _('Input') }}</div>
                <div class="editor-content">
                    <div id="input-editor"></div>
                </div>
            </div>

            <div class="editor-panel">
                <div class="editor-header">{{ _('Output') }}</div>
                <div class="editor-content">
                    <div id="output-display"></div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

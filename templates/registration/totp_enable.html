{% extends "common-content.html" %}

{% block media %}
    <style>
        .inline-header {
            font-size: 1.1em;
            padding: 4px 8px;
            padding-left: 0;
        }

        .block-header {
            font-size: 1.1em;
        }

        .block-header:first-of-type {
            padding-top: 0.5em;
        }

        #center-float {
            position: relative;
            margin: 0 auto auto -28.5em;
            left: 50%;
            width: 700px;
        }

        #totp-enable-form {
            border: none;
            background: none;
            max-width: 700px;
        }

        .totp-qr-code img, .totp-qr-code canvas {
            width: 400px;
            max-width: 100%;
            margin: 0 auto;
            display: block;
            -ms-interpolation-mode: nearest-neighbor;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: -webkit-crisp-edges;
            image-rendering: -o-crisp-edges;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        .scratch-codes {
            white-space: pre-line;
        }
    </style>
{% endblock %}

{% block content_js_media %}
    <script>
        $(function () {
            if (window.navigator.userAgent.indexOf('Edge') >= 0) {
                var $qr = $('.totp-qr-code');
                var $canvas = $('<canvas width="400" height="400">').appendTo($qr);
                var ctx = $canvas[0].getContext('2d');
                $qr.find('img').on('load', function () {
                    ctx.msImageSmoothingEnabled = false;
                    ctx.imageSmoothingEnabled = false;
                    ctx.drawImage(this, 0, 0, 400, 400);
                    $(this).hide();
                });
            }
        });
    </script>
{% endblock %}

{% block body %}
    <div id="center-float">
        <form id="totp-enable-form" action="" method="post" class="form-area">
            {% csrf_token %}

            <div class="block-header">{{ _('Scan this code with your authenticator app:') }}</div>
            <div class="totp-qr-code"><img src="{{ qr_code }}" alt="{{ _('QR code') }}"></div>
            <div class="inline-header">{{ _('Or enter this code manually:') }}
                <code class="totp-code">{{ totp_key }}</code>
            </div>
            <hr>
            {% if form.totp_or_scratch_code.errors or form.non_field_errors() %}
                <div class="form-errors">
                    {{ form.totp_or_scratch_code.errors }}
                    {{ form.non_field_errors() }}
                </div>
            {% endif %}
            <div>
                <label class="inline-header grayed">{{ _('Enter the 6-digit code generated by your app:') }}</label>
                <span class="fullwidth">{{ form.totp_or_scratch_code }}</span>
            </div>
            <button style="margin-top: 0.5em" class="button" type="submit">{{ _('Enable Two Factor Authentication') }}</button>
            <div class="scratch-codes">
                <label class="inline-header grayed">{{ _('Below is a list of one-time use scratch codes. 
                                                          These codes can only be used once and are for emergency use.
                                                          You can use these codes to login to your account or disable two-factor authentication.
                                                          If you ever need more scratch codes, you can regenerate them on the edit profile tab.
                                                          Please write these down and keep them in a secure location.
                                                          These codes will never be shown again after you enable two-factor authentication.') }}</label>
                <pre><code><span class="fullwidth">{{ scratch_codes|join('\n') }}</span></code></pre>
            </div>
        </form>
    </div>
{% endblock %}
